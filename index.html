<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Collaborative Document Editor</title>
  <style>
    /* Stylování editoru, kurzoru a zvýrazněného textu */
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
    }
    .container {
      width: 80%;
      max-width: 800px;
      height: 80%;
      background: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }
    #editor {
      width: 100%;
      height: 90%;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      outline: none;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
    }
    .cursor {
      position: absolute;
      width: 2px;
      height: 20px;
      background: red;
    }
    .highlight {
      background: yellow;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="editor" contenteditable="true"></div>
    <div id="cursor" class="cursor"></div>
  </div>

  <script>
    const ws = new WebSocket('ws://3.127.66.88:8080');
    const editor = document.getElementById('editor');
    const cursor = document.getElementById('cursor');
    const userId = Date.now(); // Unikátní ID pro uživatele

    // Inicializace WebSocket
    ws.onopen = () => {
      console.log('Připojeno k serveru');
    };

    // Zpracování příchozích zpráv
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      switch (data.type) {
        case 'textUpdate':
          editor.innerHTML = data.content;
          break;
        case 'cursorUpdate':
          updateCursor(data.cursor);
          break;
        case 'selectionUpdate':
          highlightSelection(data.selection);
          break;
        default:
          break;
      }
    };

    // Funkce pro posílání změn na server
    editor.addEventListener('input', () => {
      const content = editor.innerHTML;
      ws.send(JSON.stringify({ type: 'textUpdate', content }));
    });

    // Funkce pro sledování pohybu myši
    editor.addEventListener('mousemove', (e) => {
      const cursorPosition = { x: e.clientX, y: e.clientY };
      ws.send(JSON.stringify({ type: 'cursorUpdate', cursor: cursorPosition }));
    });

    // Funkce pro sledování změny výběru textu
    editor.addEventListener('select', () => {
      const selection = window.getSelection();
      const selectedText = selection.toString();
      if (selectedText) {
        const selectionData = {
          start: selection.anchorOffset,
          end: selection.focusOffset,
          text: selectedText
        };
        ws.send(JSON.stringify({ type: 'selectionUpdate', selection: selectionData }));
      }
    });

    // Funkce pro aktualizaci pozice kurzoru
    function updateCursor(cursorPosition) {
      cursor.style.left = `${cursorPosition.x}px`;
      cursor.style.top = `${cursorPosition.y}px`;
    }

    // Funkce pro zvýraznění textu na základě informace od serveru
    function highlightSelection(selection) {
      const range = new Range();
      const selectionData = window.getSelection();
      const startContainer = editor.childNodes[0];
      const startOffset = selection.start;
      const endOffset = selection.end;

      range.setStart(startContainer, startOffset);
      range.setEnd(startContainer, endOffset);
      const span = document.createElement('span');
      span.className = 'highlight';
      range.surroundContents(span);
    }
  </script>
</body>
</html>
